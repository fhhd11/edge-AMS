openapi: 3.1.0
info:
  title: Supabase Edge AMS API
  version: 0.1.0
  description: |
    Minimalist Agent Management Service exposing template lifecycle and agent
    configuration workflows for Letta agents. All responses are JSON.
servers:
  - url: https://{project-ref}.supabase.co/functions/v1/ams/api/v1
    description: Supabase Edge Function deployment
    variables:
      project-ref:
        default: project-ref
paths:
  /health:
    get:
      summary: Service health probe
      responses:
        '200':
          description: Health summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  checks:
                    type: object
  /templates/validate:
    post:
      summary: Validate an Agent File without persisting it
      requestBody:
        required: true
        content:
          application/x-yaml:
            schema:
              type: string
          application/json:
            schema:
              type: string
      responses:
        '200':
          description: Validation status
          content:
            application/json:
              schema:
                type: object
                properties:
                  format:
                    type: string
                    enum: [yaml, json]
                  validation:
                    type: object
                    properties:
                      valid:
                        type: boolean
                      errors:
                        type: array
                        items:
                          type: string
        '400':
          description: Invalid payload
  /templates/publish:
    post:
      summary: Publish a new immutable Agent File version
      parameters:
        - in: header
          name: Idempotency-Key
          schema:
            type: string
          required: false
      requestBody:
        required: true
        content:
          application/x-yaml:
            schema:
              type: string
          application/json:
            schema:
              type: string
      responses:
        '200':
          description: Published metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublishResponse'
        '400':
          description: Validation or SemVer error
        '409':
          description: Version or idempotency conflict
  /agents/create:
    post:
      summary: Create a personalised Letta agent from a template
      parameters:
        - in: header
          name: Idempotency-Key
          schema:
            type: string
        - in: header
          name: X-User-Id
          description: Owner of the agent (trusted header from Zuplo)
          schema:
            type: string
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAgentInput'
      responses:
        '200':
          description: Agent created
          content:
            application/json:
              schema:
                type: object
                properties:
                  agent:
                    type: object
                  template_checksum:
                    type: string
        '400':
          description: Invalid request
        '409':
          description: Duplicate idempotency key
  /me:
    get:
      summary: Retrieve the authenticated user's profile
      parameters:
        - in: header
          name: X-User-Id
          description: Trusted Zuplo header with the authenticated user's id
          schema:
            type: string
          required: true
      responses:
        '200':
          description: Profile payload (null when no profile exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  profile:
                    oneOf:
                      - $ref: '#/components/schemas/UserProfile'
                      - type: 'null'
        '401':
          description: Missing user context
  /agents/{agent_id}/upgrade:
    post:
      summary: Upgrade an agent configuration to a newer template version
      parameters:
        - in: path
          name: agent_id
          required: true
          schema:
            type: string
        - in: header
          name: Idempotency-Key
          schema:
            type: string
        - in: header
          name: X-User-Id
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpgradeAgentInput'
      responses:
        '200':
          description: Dry-run or applied plan summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  plan:
                    type: array
                    items:
                      $ref: '#/components/schemas/MigrationStep'
                  diff:
                    type: array
                    items:
                      type: object
                  dry_run:
                    type: boolean
        '404':
          description: Agent not found
        '409':
          description: Duplicate idempotency key
components:
  schemas:
    PublishResponse:
      type: object
      properties:
        template_id:
          type: string
        version:
          type: string
        checksum:
          type: string
        is_latest:
          type: boolean
    CreateAgentInput:
      type: object
      required:
        - template_id
      properties:
        template_id:
          type: string
        version:
          type: string
        use_latest:
          type: boolean
        variables:
          type: object
          additionalProperties: true
        agent_name:
          type: string
    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
          nullable: true
        litellm_key:
          type: string
          nullable: true
        letta_agent_id:
          type: string
          nullable: true
        agent_status:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        name:
          type: string
          nullable: true
    UpgradeAgentInput:
      type: object
      properties:
        target_version:
          type: string
        use_latest:
          type: boolean
        allow_minor_auto:
          type: boolean
        dry_run:
          type: boolean
        use_queue:
          type: boolean
    MigrationStep:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [json_patch, script]
        description:
          type: string
        patch:
          type: array
          items:
            type: object
        script:
          type: object
          properties:
            language:
              type: string
              enum: [js]
            code:
              type: string
