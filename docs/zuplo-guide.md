# Zuplo Integration Guide

This document explains how to configure Zuplo so that all Letta agent traffic
is routed through the billing-aware LiteLLM proxy.

## 1. Route Template

Create a route in Zuplo that forwards agent messaging traffic to the LiteLLM
proxy. The canonical path pattern is:

```
/api/v1/agents/{userId}/messages
```

### Configuration highlights

- **Upstream URL**: `https://<your-litellm-proxy-domain>/agents/{userId}/messages`
- **Security Policy**: Require the Zuplo-managed JWT or API key issued to
  trusted clients.
- **Transformations**: Inject the LiteLLM workspace key corresponding to the
  `{userId}` by using Zuplo's policy scripting.
- **Logging**: Forward correlation IDs from `X-Correlation-Id` headers to the
  upstream for observability alignment with AMS.

## 2. Request Enrichment

Zuplo is the system of record for user identity. Configure an outbound policy
that sets the following headers before forwarding the request to Supabase AMS:

- `X-User-Id`: the UUID of the authenticated user or workspace that owns the
  agent.
- `Authorization`: Supabase service role token (if invoking the function via
  REST) or rely on `supabase.functions.invoke` within Zuplo's serverless
  environment.
- `Idempotency-Key`: optional but recommended for create/publish/upgrade to
  protect against retries.

## 3. OpenAPI Synchronisation

Upload `docs/openapi.yaml` to Zuplo so the ingress routes stay in sync with the
AMS contract. Zuplo can automatically scaffold request validators from the
schema, reducing the risk of malformed `.af` payloads reaching the function.

## 4. Billing Invariant Validation

Add a post-response policy that asserts the `model_endpoint` and
`embedding_endpoint` returned from the Letta API both equal

```
${ZUPLO_BASE_URL}/api/v1/agents/${userId}/messages
```

This defensive check ensures agents cannot bypass the billing proxy even if
someone attempts to publish a malicious `.af` file.

## 5. Observability

Forward Zuplo logs and metrics to your observability stack. Include the
`X-Correlation-Id` header generated by AMS so traces can be followed end-to-end
across Zuplo, Supabase, Letta, and LiteLLM.
